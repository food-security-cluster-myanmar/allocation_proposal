"0","states <- msna %>%
  mutate(state = str_replace_all(state, ""_"", "" ""),
         state = str_remove_all(state, ""east|west|north|south""), 
         state = str_trim(state),
         state = str_to_title(state)) %>% 
  mutate(status = case_when(fs_calculated_fcs <= 21 ~ ""poor"",
                            fs_calculated_fcs >=21.5 & fs_calculated_fcs <= 35 ~ ""borderline"", 
                            fs_calculated_fcs > 35 ~ ""acceptable"")) %>% 
  group_by(state, status) %>% 
  summarise(weight = sum(weights, na.rm = TRUE), 
            .groups = ""drop"") %>% 
  mutate(state = str_replace_all(state, ""_"", "" ""),
         state = str_remove_all(state, ""east|west|north|south""), 
         state = str_trim(state),
         state = str_to_title(state)) %>% 
  left_join(survey %>%
              mutate(
                fcs_status = case_when(
                  hhfcs <= 21 ~ ""poor"",
                  hhfcs >= 21.5 &
                    hhfcs <= 35 ~ ""borderline"",
                  hhfcs > 35 ~ ""acceptable""
                ),
                rcsi_status = ifelse(rcsi >= 4,
                                     ""marginal"", ""secure"")
              ) %>%
              group_by(adm_name, fcs_status, rcsi_status) %>%
              summarise(weights = sum(weight_final), 
                        .groups = ""drop"") %>%
              ungroup() %>%
              filter(fcs_status == ""acceptable"") %>%
              group_by(adm_name) %>% 
              mutate(pc = weights / sum(weights)) %>% 
              select(state = adm_name, rcsi_status, pc) %>%
              pivot_wider(names_from = rcsi_status,
                          values_from = pc), 
            by = ""state"") %>% 
  pivot_longer(cols = c(marginal, secure)) %>% 
  mutate(domain = case_when(
    status == ""poor"" ~ ""severely_insecure"", 
    status == ""borderline"" ~ ""moderately_insecure"", 
    status == ""acceptable"" & name == ""marginal"" ~ ""marginally_secure"", 
    status == ""acceptable"" & name == ""secure"" ~ ""secure"")) %>% 
  mutate(final_weight = case_when(domain == ""severely_insecure"" ~ weight, 
                                  domain == ""moderately_insecure"" ~ weight, 
                                  domain == ""marginally_secure"" ~ value * weight, 
                                  domain == ""secure"" ~ value * weight)) %>% 
  filter(!is.na(final_weight)) %>% 
  group_by(state) %>%
  mutate(pc_weight = final_weight / sum(final_weight, na.rm = TRUE)) %>% 
  ungroup() %>% 
  left_join(pin %>%
              group_by(state) %>%
              summarise(population = sum(population_2021_proj, na.rm = TRUE)) %>%
              mutate(state =
                       str_trim(
                         str_remove_all(state, ""\\(North\\)|\\(South\\)|\\(East\\)|\\(West\\)"")
                       )) %>%
              group_by(state) %>%
              summarise_at(""population"", sum), 
            by = ""state"") %>% 
  mutate(moderately_insecure = ifelse(domain == ""moderately_insecure"", 
                                      pc_weight * population, 0),   
         severely_insecure = ifelse(domain == ""severely_insecure"", 
                                    pc_weight * population, 0)) %>% 
  distinct(state, domain, population, weight, final_weight, pc_weight) %>% 
  mutate(PIN = moderately_insecure + severely_insecure)
"
"2","Error: Problem with `mutate()` column `PIN`.
[34mi[39m `PIN = moderately_insecure + severely_insecure`.
[31mx[39m object 'moderately_insecure' not found
[90mRun `rlang::last_error()` to see where the error occurred.[39m
"
